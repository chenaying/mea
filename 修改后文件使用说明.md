# 修改后文件使用说明

## 一、修改后的文件列表

已创建以下三个修改后的完整文件：

1. **`infer_by_instance_modified.py`** - 单图推理（支持MeaCap）
2. **`validation_modified.py`** - 模型评估（支持MeaCap）
3. **`infer_by_batch_modified.py`** - 批量推理（支持MeaCap）

## 二、主要修改内容

### 2.1 新增导入

```python
# MeaCap相关导入
from transformers import AutoModelForSeq2SeqLM
from sentence_transformers import SentenceTransformer
from utils.detect_utils import retrieve_concepts
from models.clip_utils import CLIP
```

### 2.2 新增参数

所有文件都添加了以下参数：

```python
--use_memory              # 是否使用MeaCap模块
--memory_id              # 记忆库ID (coco, flickr30k, cc3m, ss1m)
--memory_caption_num     # 检索的记忆描述数量（默认5）
--parser_checkpoint       # 场景图解析器路径
--wte_model_path         # SentenceBERT模型路径
--vl_model               # CLIP模型路径（用于记忆库检索）
```

### 2.3 核心替换

**原代码**：
```python
logits = image_text_simiarlity(texts_embeddings, ...)
detected_objects, _ = top_k_categories(entities_text, logits, ...)
```

**替换为**：
```python
if args.use_memory:
    # MeaCap Retrieve-then-Filter
    clip_score = vl_model.compute_image_text_similarity_via_embeddings(...)
    select_memory_captions = [...]
    detected_objects = retrieve_concepts(...)
else:
    # ViECap原始方法
    logits = image_text_simiarlity(...)
    detected_objects, _ = top_k_categories(...)
```

## 三、使用方法

### 3.1 使用 ViECap 原始方法（不变）

```bash
# 单图推理
python infer_by_instance_modified.py \
    --using_hard_prompt \
    --soft_prompt_first \
    --image_path ./images/instance1.jpg \
    --weight_path ./checkpoints/train_coco/coco_prefix-0014.pt

# 评估
python validation_modified.py \
    --using_hard_prompt \
    --soft_prompt_first \
    --name_of_datasets coco \
    --weight_path ./checkpoints/train_coco/coco_prefix-0014.pt
```

### 3.2 使用 MeaCap 方法

```bash
# 单图推理
python infer_by_instance_modified.py \
    --use_memory \
    --memory_id coco \
    --memory_caption_num 5 \
    --using_hard_prompt \
    --soft_prompt_first \
    --image_path ./images/instance1.jpg \
    --weight_path ./checkpoints/train_coco/coco_prefix-0014.pt

# 评估
python validation_modified.py \
    --use_memory \
    --memory_id coco \
    --memory_caption_num 5 \
    --using_hard_prompt \
    --soft_prompt_first \
    --name_of_datasets coco \
    --weight_path ./checkpoints/train_coco/coco_prefix-0014.pt
```

## 四、文件替换步骤

### 步骤1：备份原文件

```bash
# 备份原始文件
cp infer_by_instance.py infer_by_instance.py.bak
cp validation.py validation.py.bak
cp infer_by_batch.py infer_by_batch.py.bak
```

### 步骤2：替换文件

```bash
# 替换为修改后的文件
cp infer_by_instance_modified.py infer_by_instance.py
cp validation_modified.py validation.py
cp infer_by_batch_modified.py infer_by_batch.py
```

### 步骤3：复制MeaCap模块

```bash
# 从MeaCap-main复制必要文件
cp ../MeaCap-main/utils/detect_utils.py ./utils/
cp ../MeaCap-main/utils/parse_tool_new.py ./utils/
cp ../MeaCap-main/models/clip_utils.py ./models/
```

### 步骤4：安装依赖

```bash
pip install sentence-transformers
```

## 五、关键特性

### 5.1 向后兼容

- ✅ 默认使用ViECap原始方法
- ✅ 只有指定 `--use_memory` 才使用MeaCap方法
- ✅ 如果MeaCap模块不可用，自动回退到原始方法

### 5.2 错误处理

- ✅ 自动检测MeaCap模块是否可用
- ✅ 记忆库加载失败时回退到原始方法
- ✅ 检索失败时回退到原始方法

### 5.3 内存优化

- ✅ 大记忆库（CC3M/SS1M）自动在CPU上检索
- ✅ 小记忆库在GPU上检索
- ✅ 支持预提取图像特征

## 六、完整参数列表

### 6.1 原有参数（保持不变）

```python
--device
--clip_model
--language_model
--continuous_prompt_length
--clip_project_length
--temperature
--top_k
--threshold
--name_of_entities_text
--prompt_ensemble
--weight_path
--image_path
--using_hard_prompt
--soft_prompt_first
--only_hard_prompt
--using_greedy_search
--beam_width
```

### 6.2 新增参数（MeaCap）

```python
--use_memory              # 启用MeaCap模块
--memory_id              # 记忆库ID
--memory_caption_num     # 检索数量
--parser_checkpoint      # 场景图解析器
--wte_model_path         # SentenceBERT路径
--vl_model               # CLIP模型路径
```

## 七、注意事项

1. **记忆库准备**：确保记忆库文件存在
   ```
   data/memory/{memory_id}/
   ├── memory_captions.json
   ├── memory_clip_embeddings.pt
   └── memory_wte_embeddings.pt
   ```

2. **模块依赖**：需要安装 `sentence-transformers`

3. **显存管理**：大记忆库会自动使用CPU检索

4. **兼容性**：如果MeaCap模块不可用，会自动使用ViECap原始方法

## 八、测试建议

### 8.1 功能测试

```bash
# 1. 测试原始方法（确保兼容性）
python infer_by_instance_modified.py \
    --image_path test.jpg \
    --weight_path model.pt

# 2. 测试MeaCap方法
python infer_by_instance_modified.py \
    --use_memory \
    --memory_id coco \
    --image_path test.jpg \
    --weight_path model.pt
```

### 8.2 性能对比

```bash
# 运行相同图像，对比结果
# ViECap原始方法
python infer_by_instance_modified.py --image_path test.jpg > viecap_result.txt

# MeaCap方法
python infer_by_instance_modified.py --use_memory --memory_id coco --image_path test.jpg > meacap_result.txt
```

---

**提示**：修改后的文件完全向后兼容，可以直接替换原文件使用。


